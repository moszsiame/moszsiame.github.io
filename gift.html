<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏ö‡∏ö Chain Reaction</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4">

    <div class="max-w-3xl mx-auto">
        <header class="text-center my-8 relative">
            <h1 class="text-3xl font-bold text-red-600 uppercase tracking-wide">Gift Chain Reaction</h1>
            <p class="text-gray-500 italic">"‡πÉ‡∏Ñ‡∏£‡πÇ‡∏î‡∏ô‡∏à‡∏±‡∏ö ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏±‡∏ö‡∏ï‡πà‡∏≠"</p>
            
            <button onclick="hardReset()" class="absolute right-0 top-0 text-gray-400 hover:text-red-600 transition text-sm flex items-center gap-1">
                <i class="fas fa-sync-alt"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
            </button>
        </header>

        <!-- Rule Alert Section -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-xl shadow-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <i class="fas fa-info-circle text-blue-500 mt-1"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-bold text-blue-800 uppercase tracking-wider">‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å</h3>
                    <div class="mt-2 text-xs text-blue-700 space-y-1">
                        <p>‚Ä¢ <strong>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏π‡∏Å‡πÇ‡∏ã‡πà:</strong> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏Ñ‡∏£ ‡∏Ñ‡∏ô‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏•‡∏∏‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏à‡∏±‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</p>
                        <p>‚Ä¢ <strong>‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ <u>‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏à‡∏±‡∏ö‡∏Å‡∏±‡∏ô</u></p>
                        <p>‚Ä¢ <strong>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ‡∏´‡∏≤‡∏Å‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Setup Phase -->
        <div id="setupArea" class="space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡πà‡∏ß‡∏°‡∏™‡∏ô‡∏∏‡∏Å</label>
                        <input type="text" id="nameInput" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-red-500 outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-400 mb-1 uppercase">‡∏Å‡∏•‡∏∏‡πà‡∏° / ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î</label>
                        <input type="text" id="groupInput" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-red-500 outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô1, ‡πÅ‡∏ú‡∏ô‡∏Å IT">
                    </div>
                </div>
                <button onclick="addPerson()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-xl transition">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100">
                <table class="w-full text-left">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">‡∏ä‡∏∑‡πà‡∏≠</th>
                            <th class="p-4 text-xs font-bold text-gray-400 uppercase">‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                            <th class="p-4"></th>
                        </tr>
                    </thead>
                    <tbody id="memberList"></tbody>
                </table>
                <div id="noData" class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
            </div>

            <button onclick="prepareGame()" id="startBtn" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold text-lg hover:bg-black transition hidden shadow-lg">
                ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å!
            </button>
        </div>

        <!-- Game Phase -->
        <div id="gameArea" class="hidden space-y-8">
            <div class="text-center">
                <div class="inline-block bg-yellow-100 text-yellow-800 px-4 py-1 rounded-full text-sm font-bold mb-4">
                    ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡∏à‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß <span id="progress">0</span> ‡∏à‡∏≤‡∏Å <span id="totalCount">0</span> ‡∏Ñ‡∏ô
                </div>
                
                <div id="activePlayerCard" class="bg-white p-8 rounded-3xl shadow-xl border-4 border-red-500 max-w-sm mx-auto pulse-animation">
                    <p class="text-gray-400 text-sm uppercase font-bold mb-2">‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏à‡∏±‡∏ö‡∏Ç‡∏≠‡∏á...</p>
                    <h2 id="activeName" class="text-4xl font-bold text-gray-800 mb-1">---</h2>
                    <p id="activeGroup" class="text-red-500 font-medium italic"></p>
                    
                    <button onclick="performDraw()" id="drawBtn" class="mt-8 w-full bg-red-600 text-white py-4 rounded-2xl font-bold text-xl hover:bg-red-700 shadow-lg transition">
                        ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 border-b pb-2 flex justify-between items-center">
                    <span>‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö (Chain History)</span>
                    <i class="fas fa-link text-gray-300"></i>
                </h3>
                <div id="historyLog" class="space-y-3"></div>
            </div>
            
            <div class="text-center">
                <button onclick="hardReset()" class="text-gray-400 hover:text-red-600 transition text-sm underline">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÄ‡∏Å‡∏°‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="finishArea" class="hidden text-center space-y-6 py-12">
            <div class="text-6xl mb-4">üéâ</div>
            <h2 class="text-3xl font-bold text-gray-800">‡∏à‡∏±‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß!</h2>
            <p class="text-gray-500">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
            <button onclick="hardReset()" class="bg-slate-800 text-white px-8 py-3 rounded-xl font-bold hover:bg-black transition">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>
    </div>

    <!-- Reveal Modal -->
    <div id="revealModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-50 hidden p-6">
        <div class="bg-white w-full max-w-md rounded-3xl p-8 text-center">
            <p id="modalGiver" class="text-gray-500 mb-2 font-medium font-bold text-lg"></p>
            <p class="text-sm text-gray-400 uppercase tracking-widest mb-6">‡∏Ñ‡∏∏‡∏ì‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏Ç‡∏≠‡∏á...</p>
            
            <div class="bg-red-50 py-10 rounded-2xl border-2 border-red-100 mb-8 shadow-inner">
                <h3 id="modalReceiver" class="text-4xl font-black text-red-600">---</h3>
                <p id="modalReceiverGroup" class="text-gray-500 italic mt-2"></p>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl mb-6">
                <p class="text-xs text-blue-600 font-bold uppercase mb-1">‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏∏‡∏Å‡∏°‡∏≤‡∏à‡∏±‡∏ö‡∏Ñ‡∏∑‡∏≠</p>
                <p id="nextTurnName" class="text-lg font-bold text-blue-900 italic">...</p>
            </div>
            
            <button onclick="closeModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold text-lg hover:bg-black transition shadow-lg">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
            </button>
        </div>
    </div>

    <script>
        let members = [];           
        let remainingGivers = [];    
        let remainingReceivers = []; 
        let activeGiver = null;      
        let finalResults = [];       
        let isGameRunning = false;   

        const STORAGE_KEY = 'gift_draw_chain_state_v2';

        window.onload = function() {
            loadAllState();
        };

        function saveAllState() {
            const state = {
                members,
                remainingGivers,
                remainingReceivers,
                activeGiver,
                finalResults,
                isGameRunning
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadAllState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) {
                updateUI();
                return;
            }

            const state = JSON.parse(saved);
            members = state.members || [];
            remainingGivers = state.remainingGivers || [];
            remainingReceivers = state.remainingReceivers || [];
            activeGiver = state.activeGiver || null;
            finalResults = state.finalResults || [];
            isGameRunning = state.isGameRunning || false;

            if (isGameRunning) {
                document.getElementById('setupArea').classList.add('hidden');
                
                if (finalResults.length === members.length) {
                    document.getElementById('finishArea').classList.remove('hidden');
                } else {
                    document.getElementById('gameArea').classList.remove('hidden');
                    document.getElementById('totalCount').innerText = members.length;
                    refreshActiveCard();
                }
                
                const log = document.getElementById('historyLog');
                log.innerHTML = '';
                [...finalResults].reverse().forEach(res => {
                    const entry = document.createElement('div');
                    entry.className = "flex items-center text-sm p-3 bg-white rounded-lg border border-gray-100 shadow-sm";
                    entry.innerHTML = `<span class="w-24 font-bold text-gray-700 text-right">${res.giver.name}</span> <i class="fas fa-arrow-right mx-3 text-red-300 scale-75"></i> <span class="font-bold text-red-600">${res.receiver.name}</span>`;
                    log.appendChild(entry);
                });
            } else {
                updateUI();
            }
        }

        function hardReset() {
            if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        function addPerson() {
            const nameEl = document.getElementById('nameInput');
            const groupEl = document.getElementById('groupInput');
            const name = nameEl.value.trim();
            const group = groupEl.value.trim() || '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
            
            if (!name) return;
            
            // ‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ Date.now() ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            members.push({ 
                id: 'id_' + Math.random().toString(36).substr(2, 9), 
                name, 
                group 
            });
            nameEl.value = '';
            nameEl.focus();
            updateUI();
            saveAllState();
        }

        function removePerson(id) {
            members = members.filter(m => m.id !== id);
            updateUI();
            saveAllState();
        }

        function updateUI() {
            const list = document.getElementById('memberList');
            const noData = document.getElementById('noData');
            const startBtn = document.getElementById('startBtn');
            
            list.innerHTML = '';
            noData.style.display = members.length === 0 ? 'block' : 'none';
            startBtn.style.display = members.length >= 2 ? 'block' : 'none';

            members.forEach((m, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-4 text-gray-400 font-mono text-sm">${i+1}</td>
                    <td class="p-4 font-bold text-gray-700">${m.name}</td>
                    <td class="p-4 text-sm text-gray-500 italic">${m.group}</td>
                    <td class="p-4 text-right">
                        <button onclick="removePerson('${m.id}')" class="text-red-300 hover:text-red-500 px-2 transition"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        function prepareGame() {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏Å‡∏é Pigeonhole Principle)
            const groupCounts = {};
            members.forEach(m => groupCounts[m.group] = (groupCounts[m.group] || 0) + 1);
            const maxGroupSize = Math.max(...Object.values(groupCounts));
            
            if (maxGroupSize > members.length / 2) {
                alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ: ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (${maxGroupSize} ‡∏Ñ‡∏ô) ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${members.length} ‡∏Ñ‡∏ô) ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏±‡∏ö‡πÑ‡∏Ç‡∏ß‡πâ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô`);
                return;
            }

            remainingGivers = JSON.parse(JSON.stringify(members));
            remainingReceivers = JSON.parse(JSON.stringify(members));
            
            // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å
            const firstIdx = Math.floor(Math.random() * remainingGivers.length);
            activeGiver = remainingGivers.splice(firstIdx, 1)[0];
            isGameRunning = true;

            document.getElementById('setupArea').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            document.getElementById('totalCount').innerText = members.length;
            
            refreshActiveCard();
            saveAllState();
        }

        function refreshActiveCard() {
            if (!activeGiver) return;
            document.getElementById('activeName').innerText = activeGiver.name;
            document.getElementById('activeGroup').innerText = `‡∏Å‡∏•‡∏∏‡πà‡∏°: ${activeGiver.group}`;
            document.getElementById('progress').innerText = finalResults.length;
        }

        function performDraw() {
            // ‡∏î‡∏∂‡∏á Candidate ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            // ‡πÉ‡∏ä‡πâ id ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î
            const candidates = remainingReceivers.filter(r => 
                r.id !== activeGiver.id && r.group !== activeGiver.group
            );

            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏Å‡∏¥‡∏î Deadlock (‡∏ó‡∏≤‡∏á‡∏ï‡∏±‡∏ô)
            if (candidates.length === 0) {
                alert("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢! ‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏†‡∏≤‡∏ß‡∏∞‡∏ó‡∏≤‡∏á‡∏ï‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå (‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                
                // ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°
                remainingGivers = JSON.parse(JSON.stringify(members));
                remainingReceivers = JSON.parse(JSON.stringify(members));
                finalResults = [];
                const firstIdx = Math.floor(Math.random() * remainingGivers.length);
                activeGiver = remainingGivers.splice(firstIdx, 1)[0];
                
                document.getElementById('historyLog').innerHTML = '';
                refreshActiveCard();
                saveAllState();
                return;
            }

            // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö
            const receiver = candidates[Math.floor(Math.random() * candidates.length)];
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•
            finalResults.push({ giver: activeGiver, receiver });
            
            // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏£‡∏≠‡πÇ‡∏î‡∏ô‡∏à‡∏±‡∏ö
            remainingReceivers = remainingReceivers.filter(r => r.id !== receiver.id);

            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô Modal
            document.getElementById('modalGiver').innerText = activeGiver.name;
            document.getElementById('modalReceiver').innerText = receiver.name;
            document.getElementById('modalReceiverGroup').innerText = `(${receiver.group})`;
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô History
            const log = document.getElementById('historyLog');
            const entry = document.createElement('div');
            entry.className = "flex items-center text-sm p-3 bg-white rounded-lg border border-gray-100 shadow-sm animate-fade-in";
            entry.innerHTML = `<span class="w-24 font-bold text-gray-700 text-right">${activeGiver.name}</span> <i class="fas fa-arrow-right mx-3 text-red-300 scale-75"></i> <span class="font-bold text-red-600">${receiver.name}</span>`;
            log.prepend(entry);

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ (‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏π‡∏Å‡πÇ‡∏ã‡πà)
            const nextGiverFromRemaining = remainingGivers.find(g => g.id === receiver.id);

            if (nextGiverFromRemaining) {
                // ‡πÄ‡∏Ñ‡∏™‡∏õ‡∏Å‡∏ï‡∏¥: ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏à‡∏±‡∏ö‡∏ï‡πà‡∏≠
                activeGiver = nextGiverFromRemaining;
                remainingGivers = remainingGivers.filter(g => g.id !== receiver.id);
                document.getElementById('nextTurnName').innerText = activeGiver.name;
            } else if (remainingGivers.length > 0) {
                // ‡πÄ‡∏Ñ‡∏™‡∏ß‡∏á‡∏õ‡∏¥‡∏î: ‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡πÑ‡∏î‡πâ "‡πÄ‡∏Ñ‡∏¢‡∏à‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß" ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
                const newIdx = Math.floor(Math.random() * remainingGivers.length);
                activeGiver = remainingGivers.splice(newIdx, 1)[0];
                document.getElementById('nextTurnName').innerText = `${activeGiver.name} (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏á‡πÉ‡∏´‡∏°‡πà)`;
            } else {
                // ‡∏à‡∏ö‡πÄ‡∏Å‡∏°
                activeGiver = null;
                document.getElementById('nextTurnName').innerText = "‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏ö‡∏â‡∏•‡∏≤‡∏Å";
            }

            saveAllState();
            document.getElementById('revealModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('revealModal').classList.add('hidden');
            if (activeGiver) {
                refreshActiveCard();
            } else {
                document.getElementById('gameArea').classList.add('hidden');
                document.getElementById('finishArea').classList.remove('hidden');
            }
            saveAllState();
        }
    </script>
</body>
</html>

